<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Friend Mapper - A World of Connections</title>
    <!-- LeafletJS CSS for the map -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <!-- Leaflet MarkerCluster CSS for grouping markers -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Custom styles */
        body {
            font-family: 'Inter', sans-serif;
            overflow: hidden;
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            transition: background 0.5s ease;
            color: #f1f5f9;
        }
        body.light-mode {
            background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%);
            color: #1e293b;
        }
        #map {
            height: 100vh;
            width: 100vw;
            z-index: 10;
        }
        /* Custom marker styles */
        .custom-marker {
            background: transparent;
            border: none;
        }
        .custom-marker svg {
            filter: drop-shadow(2px 3px 3px rgba(0,0,0,0.4));
            transition: all 0.3s ease;
        }
        .custom-marker:hover svg {
            transform: scale(1.15) translateY(-5px);
        }
        /* Pulse animation for markers */
        .pulse-marker {
            animation: pulseAnimation 1.5s infinite;
        }
        @keyframes pulseAnimation {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }
        /* Custom popup styling */
        .leaflet-popup-content-wrapper {
            background-color: #f8fafc;
            color: #0f172a;
            border-radius: 12px;
            box-shadow: 0 10px 25px -3px rgba(0, 0, 0, 0.2), 0 4px 6px -4px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }
        .dark-mode .leaflet-popup-content-wrapper {
            background-color: #334155;
            color: #f1f5f9;
            box-shadow: 0 10px 25px -3px rgba(0, 0, 0, 0.4), 0 4px 6px -4px rgba(0, 0, 0, 0.2);
        }
        .leaflet-popup-content {
            margin: 16px 20px;
            font-size: 14px;
            line-height: 1.6;
        }
        .leaflet-popup-tip {
            background-color: #f8fafc;
        }
        .dark-mode .leaflet-popup-tip {
            background-color: #334155;
        }
        .custom-popup-content .name {
            font-weight: 700;
            font-size: 16px;
            margin-bottom: 4px;
            color: #1e293b;
        }
        .dark-mode .custom-popup-content .name {
            color: #f1f5f9;
        }
        .custom-popup-content .location {
            font-size: 12px;
            color: #64748b;
            margin-bottom: 8px;
        }
        .custom-popup-content .coords {
            font-size: 11px;
            color: #94a3b8;
            margin-bottom: 12px;
            font-style: italic;
        }
        .custom-popup-content .details {
            font-size: 13px;
            color: #475569;
            margin-bottom: 12px;
            border-top: 1px solid #e2e8f0;
            padding-top: 8px;
        }
        .dark-mode .custom-popup-content .details {
            color: #cbd5e1;
            border-top: 1px solid #475569;
        }
        .custom-popup-content .popup-button {
            padding: 6px 12px;
            border-radius: 6px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
            margin-right: 8px;
            font-size: 12px;
        }
        .popup-button.edit {
            background-color: #3b82f6;
            color: white;
        }
        .popup-button.edit:hover {
            background-color: #2563eb;
            transform: translateY(-1px);
        }
        .popup-button.delete {
            background-color: #ef4444;
            color: white;
        }
        .popup-button.delete:hover {
            background-color: #dc2626;
            transform: translateY(-1px);
        }
        /* Dark mode styles */
        .dark-mode .header-card {
            background: linear-gradient(135deg, rgba(30, 41, 59, 0.95) 0%, rgba(15, 23, 42, 0.95) 100%);
            color: #f1f5f9;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .light-mode .header-card {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.95) 0%, rgba(241, 245, 249, 0.95) 100%);
            color: #1e293b;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(0, 0, 0, 0.1);
        }
        .dark-mode .search-input {
            background: rgba(30, 41, 59, 0.8);
            border-color: #475569;
            color: #f1f5f9;
            backdrop-filter: blur(10px);
        }
        .light-mode .search-input {
            background: rgba(255, 255, 255, 0.8);
            border-color: #e2e8f0;
            color: #1e293b;
            backdrop-filter: blur(10px);
        }
        .dark-mode .search-input::placeholder {
            color: #94a3b8;
        }
        .light-mode .search-input::placeholder {
            color: #94a3b8;
        }
        .dark-mode .modal-content {
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            color: #f1f5f9;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .light-mode .modal-content {
            background: linear-gradient(135deg, #ffffff 0%, #f1f5f9 100%);
            color: #1e293b;
            border: 1px solid rgba(0, 0, 0, 0.1);
        }
        .dark-mode .modal-input {
            background: rgba(30, 41, 59, 0.7);
            border-color: #475569;
            color: #f1f5f9;
        }
        .light-mode .modal-input {
            background: rgba(255, 255, 255, 0.7);
            border-color: #e2e8f0;
            color: #1e293b;
        }
        .dark-mode .modal-input::placeholder {
            color: #94a3b8;
        }
        .light-mode .modal-input::placeholder {
            color: #94a3b8;
        }
        /* Map bounds indicator */
        .bounds-indicator {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            z-index: 1000;
            display: none;
            backdrop-filter: blur(10px);
        }
        .dark-mode .bounds-indicator {
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
        }
        /* Custom cluster styles */
        .custom-cluster {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.9) 0%, rgba(37, 99, 235, 0.9) 100%);
            border-radius: 50%;
            color: white;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: bold;
            box-shadow: 0 0 0 5px rgba(59, 130, 246, 0.3);
            backdrop-filter: blur(5px);
            border: 2px solid white;
        }
        .dark-mode .custom-cluster {
            border: 2px solid rgba(255, 255, 255, 0.5);
        }
        .custom-cluster.small {
            width: 40px;
            height: 40px;
            font-size: 14px;
        }
        .custom-cluster.medium {
            width: 50px;
            height: 50px;
            font-size: 16px;
        }
        .custom-cluster.large {
            width: 60px;
            height: 60px;
            font-size: 18px;
        }
        /* Icon selector styles */
        .icon-selector {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            margin-top: 8px;
        }
        .icon-option {
            padding: 8px;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            border: 2px solid transparent;
            background: rgba(255, 255, 255, 0.1);
        }
        .light-mode .icon-option {
            background: rgba(0, 0, 0, 0.05);
        }
        .icon-option:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        .dark-mode .icon-option:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        .light-mode .icon-option:hover {
            background: rgba(0, 0, 0, 0.1);
        }
        .icon-option.selected {
            border-color: #3b82f6;
            background: rgba(59, 130, 246, 0.2);
            transform: scale(1.1);
        }
        /* City search dropdown */
        .city-suggestions {
            position: absolute;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            width: 100%;
            margin-top: 4px;
        }
        .dark-mode .city-suggestions {
            background: #334155;
            color: #f1f5f9;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        .city-suggestion {
            padding: 10px 12px;
            cursor: pointer;
            transition: background 0.2s;
            border-bottom: 1px solid #f1f5f9;
        }
        .dark-mode .city-suggestion {
            border-bottom: 1px solid #475569;
        }
        .city-suggestion:last-child {
            border-bottom: none;
        }
        .city-suggestion:hover {
            background-color: #f1f5f9;
        }
        .dark-mode .city-suggestion:hover {
            background-color: #475569;
        }
        /* Buttons */
        .action-button {
            transition: all 0.3s ease;
        }
        .action-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }
        /* Floating elements animation */
        @keyframes float {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-5px); }
            100% { transform: translateY(0px); }
        }
        .floating {
            animation: float 3s ease-in-out infinite;
        }
        /* Gradient text */
        .gradient-text {
            background: linear-gradient(135deg, #3b82f6 0%, #ec4899 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        /* Map overlay controls */
        .map-control {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            transition: all 0.3s ease;
        }
        .light-mode .map-control {
            background: rgba(255, 255, 255, 0.8);
            border: 1px solid rgba(0, 0, 0, 0.1);
        }
        .map-control:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }
        .light-mode .map-control:hover {
            background: rgba(255, 255, 255, 0.9);
        }
    </style>
</head>
<body class="dark-mode">
    <!-- The main map container -->
    <div id="map"></div>
    
    <!-- Map bounds indicator -->
    <div class="bounds-indicator" id="bounds-indicator">Reached map boundary</div>

    <!-- Header/Title Overlay -->
    <div class="absolute top-0 left-0 right-0 p-4 flex justify-center z-20 pointer-events-none">
        <div class="header-card p-4 rounded-xl shadow-lg text-center floating">
            <h1 class="text-2xl font-bold gradient-text">Friend Mapper</h1>
            <p class="text-sm text-gray-600 dark:text-gray-300">A world of our connections</p>
        </div>
    </div>

    <!-- Theme Toggle -->
    <div class="absolute top-4 right-4 z-20">
        <button id="theme-toggle" class="map-control p-3 rounded-full shadow-lg action-button">
            <svg id="theme-icon" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-800 dark:text-yellow-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />
            </svg>
        </button>
    </div>

    <!-- Search Bar Overlay -->
    <div class="absolute top-24 left-1/2 -translate-x-1/2 w-full max-w-sm px-4 z-20">
        <div class="relative rounded-lg">
            <input type="text" id="search-input" placeholder="Search for a friend..." class="search-input w-full p-3 pl-10 rounded-lg shadow-md border focus:ring-2 focus:ring-blue-500 focus:outline-none transition">
            <svg class="w-5 h-5 text-gray-400 absolute top-1/2 left-3 -translate-y-1/2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M9 3.5a5.5 5.5 0 100 11 5.5 5.5 0 000-11zM2 9a7 7 0 1112.452 4.391l3.328 3.329a.75.75 0 11-1.06 1.06l-3.329-3.328A7 7 0 012 9z" clip-rule="evenodd" />
            </svg>
            <div id="search-results" class="absolute mt-1 w-full bg-white dark:bg-slate-800 rounded-lg shadow-lg overflow-hidden hidden z-40"></div>
        </div>
    </div>

    <!-- Help Button -->
    <div class="absolute bottom-4 right-4 z-20">
        <button id="help-button" class="map-control p-3 rounded-full shadow-lg action-button">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
        </button>
    </div>

    <!-- Map Style Toggle -->
    <div class="absolute bottom-4 left-4 z-20 flex flex-col space-y-2">
        <button id="map-style-satellite" class="map-control p-2 rounded-lg action-button" title="Satellite View">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9a9 9 0 01-9-9m9 9c1.657 0 3-4.03 3-9s-1.343-9-3-9m0 18c-1.657 0-3-4.03-3-9s1.343-9 3-9m-9 9a9 9 0 019-9" />
            </svg>
        </button>
        <button id="map-style-terrain" class="map-control p-2 rounded-lg action-button" title="Terrain View">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 6l3 1m0 0l-3 9a5.002 5.002 0 006.001 0M6 7l3 9M6 7l6-2m6 2l3-1m-3 1l-3 9a5.002 5.002 0 006.001 0M18 7l3 9m-3-9l-6-2m0-2v2m0 16V5m0 16H9m3 0h3" />
            </svg>
        </button>
        <button id="map-style-default" class="map-control p-2 rounded-lg action-button" title="Default View">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7" />
            </svg>
        </button>
    </div>

    <!-- Instructions Modal -->
    <div id="instructions-modal" class="fixed inset-0 bg-black bg-opacity-70 backdrop-blur-sm flex items-center justify-center z-50 transition-opacity duration-300 hidden">
        <div class="bg-white dark:bg-slate-800 rounded-xl shadow-2xl p-6 w-full max-w-md mx-4 transform transition-all duration-300 scale-95 opacity-0" id="instructions-content">
            <h2 class="text-2xl font-bold text-gray-800 dark:text-white mb-4">Welcome to Friend Mapper!</h2>
            <div class="space-y-4 mb-6">
                <div class="flex items-start">
                    <div class="bg-blue-100 dark:bg-blue-900/30 p-2 rounded-full mr-3">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-blue-600 dark:text-blue-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                        </svg>
                    </div>
                    <div>
                        <h3 class="font-semibold text-gray-800 dark:text-white">Add Friends</h3>
                        <p class="text-gray-600 dark:text-gray-300 text-sm">Click anywhere on the map to add a friend at that location</p>
                    </div>
                </div>
                <div class="flex items-start">
                    <div class="bg-blue-100 dark:bg-blue-900/30 p-2 rounded-full mr-3">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-blue-600 dark:text-blue-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                        </svg>
                    </div>
                    <div>
                        <h3 class="font-semibold text-gray-800 dark:text-white">Search Friends</h3>
                        <p class="text-gray-600 dark:text-gray-300 text-sm">Use the search bar to find and locate your friends</p>
                    </div>
                </div>
                <div class="flex items-start">
                    <div class="bg-blue-100 dark:bg-blue-900/30 p-2 rounded-full mr-3">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-blue-600 dark:text-blue-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7" />
                        </svg>
                    </div>
                    <div>
                        <h3 class="font-semibold text-gray-800 dark:text-white">Drag & Drop</h3>
                        <p class="text-gray-600 dark:text-gray-300 text-sm">Drag markers to adjust their position</p>
                    </div>
                </div>
                <div class="flex items-start">
                    <div class="bg-blue-100 dark:bg-blue-900/30 p-2 rounded-full mr-3">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-blue-600 dark:text-blue-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                        </svg>
                    </div>
                    <div>
                        <h3 class="font-semibold text-gray-800 dark:text-white">Manage Friends</h3>
                        <p class="text-gray-600 dark:text-gray-300 text-sm">Click on a friend's marker to edit or delete them</p>
                    </div>
                </div>
            </div>
            <button id="close-instructions" class="w-full bg-blue-500 hover:bg-blue-600 text-white py-2 rounded-lg font-medium transition action-button">Start Mapping!</button>
        </div>
    </div>

    <!-- Modal for adding/editing a friend -->
    <div id="friend-modal" class="fixed inset-0 bg-black bg-opacity-60 backdrop-blur-sm flex items-center justify-center z-30 hidden transition-opacity">
        <div class="modal-content rounded-lg shadow-xl p-6 w-full max-w-md transform transition-all scale-95 opacity-0" id="modal-content">
            <h2 id="modal-title" class="text-xl font-bold mb-4 text-gray-800 dark:text-white">Add a Friend</h2>
            <div class="space-y-4">
                <div>
                    <label for="friend-name" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Friend's Name</label>
                    <input type="text" id="friend-name" class="modal-input mt-1 block w-full px-3 py-2 border rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="Enter name">
                </div>
                <div class="relative">
                    <label for="friend-city" class="block text-sm font-medium text-gray-700 dark:text-gray-300">City</label>
                    <input type="text" id="friend-city" class="modal-input mt-1 block w-full px-3 py-2 border rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="Enter city name">
                    <div id="city-suggestions" class="city-suggestions hidden"></div>
                </div>
                <div>
                    <label for="friend-fact" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Fun Fact</label>
                    <textarea id="friend-fact" class="modal-input mt-1 block w-full px-3 py-2 border rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="Share something interesting" rows="2"></textarea>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Select Icon</label>
                    <div class="icon-selector" id="icon-selector">
                        <div class="icon-option selected" data-icon="🎮">🎮</div>
                        <div class="icon-option" data-icon="🎵">🎵</div>
                        <div class="icon-option" data-icon="⚽">⚽</div>
                        <div class="icon-option" data-icon="📚">📚</div>
                        <div class="icon-option" data-icon="✈️">✈️</div>
                        <div class="icon-option" data-icon="🎨">🎨</div>
                        <div class="icon-option" data-icon="🍳">🍳</div>
                        <div class="icon-option" data-icon="🎬">🎬</div>
                        <div class="icon-option" data-icon="🏕️">🏕️</div>
                        <div class="icon-option" data-icon="🐾">🐾</div>
                        <div class="icon-option" data-icon="🎭">🎭</div>
                        <div class="icon-option" data-icon="🚴">🚴</div>
                    </div>
                </div>
            </div>
            <div class="mt-6 flex justify-end space-x-3">
                <button id="cancel-button" class="px-4 py-2 bg-gray-200 dark:bg-slate-700 dark:text-white text-gray-800 rounded-md hover:bg-gray-300 dark:hover:bg-slate-600 transition action-button">Cancel</button>
                <button id="save-button" class="px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600 transition action-button">Save Friend</button>
            </div>
        </div>
    </div>

    <!-- Confirmation Modal for deleting a friend -->
    <div id="confirm-modal" class="fixed inset-0 bg-black bg-opacity-60 backdrop-blur-sm flex items-center justify-center z-50 hidden transition-opacity">
        <div class="modal-content rounded-lg shadow-xl p-6 w-full max-w-sm transform transition-all scale-95 opacity-0" id="confirm-modal-content">
            <h2 id="confirm-modal-title" class="text-xl font-bold mb-2 text-gray-800 dark:text-white">Are you sure?</h2>
            <p class="text-sm text-gray-600 dark:text-gray-300 mb-6">This will permanently delete the marker for <strong id="confirm-friend-name" class="font-semibold"></strong>.</p>
            <div class="mt-6 flex justify-end space-x-3">
                <button id="confirm-cancel-button" class="px-4 py-2 bg-gray-200 dark:bg-slate-700 dark:text-white text-gray-800 rounded-md hover:bg-gray-300 dark:hover:bg-slate-600 transition action-button">Cancel</button>
                <button id="confirm-delete-button" class="px-4 py-2 bg-red-500 text-white rounded-md hover:bg-red-600 transition action-button">Yes, Delete</button>
            </div>
        </div>
    </div>

    <!-- LeafletJS for the map -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <!-- Leaflet MarkerCluster for grouping markers -->
    <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // MAP INITIALIZATION
            // Set bounds for the entire world
            const southWest = L.latLng(-90, -180);
            const northEast = L.latLng(90, 180);
            const bounds = L.latLngBounds(southWest, northEast);
            
            const map = L.map('map', {
                maxZoom: 18,
                minZoom: 2,
                maxBounds: bounds,
                maxBoundsViscosity: 0.9 // How much the map resists going beyond the maxBounds
            }).setView([20, 0], 2);

            // Define different tile layers
            const lightTiles = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
                maxZoom: 20,
                noWrap: true // Prevent tile wrapping
            });

            const darkTiles = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
                maxZoom: 20,
                noWrap: true // Prevent tile wrapping
            });

            const satelliteTiles = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                attribution: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community',
                maxZoom: 20,
                noWrap: true
            });

            const terrainTiles = L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
                attribution: 'Map data: &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, <a href="http://viewfinderpanoramas.org">SRTM</a> | Map style: &copy; <a href="https://opentopomap.org">OpenTopoMap</a>',
                maxZoom: 17,
                noWrap: true
            });

            // Add dark tiles by default
            darkTiles.addTo(map);

            // Add error handling for tile loading
            map.on('tileerror', function(error) {
                console.error('Tile loading error:', error);
            });
            
            // Show bounds indicator when user tries to pan beyond bounds
            let boundsIndicatorTimeout;
            map.on('drag', function() {
                if (!map.getBounds().intersects(bounds)) {
                    const indicator = document.getElementById('bounds-indicator');
                    indicator.style.display = 'block';
                    
                    clearTimeout(boundsIndicatorTimeout);
                    boundsIndicatorTimeout = setTimeout(() => {
                        indicator.style.display = 'none';
                    }, 2000);
                }
            });

            // STATE MANAGEMENT
            let friends = [];
            const markers = L.markerClusterGroup({
                spiderfyOnMaxZoom: true,
                showCoverageOnHover: false,
                zoomToBoundsOnClick: true,
                iconCreateFunction: function(cluster) {
                    const count = cluster.getChildCount();
                    let size = 'small';
                    if (count > 10) size = 'medium';
                    if (count > 20) size = 'large';
                    
                    return L.divIcon({
                        html: `<div class="custom-cluster ${size}">${count}</div>`,
                        className: 'marker-cluster-custom',
                        iconSize: L.point(40, 40)
                    });
                }
            });
            let markerIdMap = {};
            let tempMarkerData = null;
            let editingFriendId = null;
            let friendIdToDelete = null;
            let selectedIcon = '🎮';
            let currentTileLayer = darkTiles;

            // Icon options for different friend types
            const iconOptions = [
                { color: '#e6194b', icon: '🎮' }, // Gaming
                { color: '#3cb44b', icon: '🎵' }, // Music
                { color: '#ffe119', icon: '⚽' }, // Sports
                { color: '#4363d8', icon: '📚' }, // Reading
                { color: '#f58231', icon: '✈️' }, // Travel
                { color: '#911eb4', icon: '🎨' }, // Art
                { color: '#46f0f0', icon: '🍳' }, // Cooking
                { color: '#f032e6', icon: '🎬' }, // Movies
                { color: '#bcf60c', icon: '🏕️' }, // Outdoors
                { color: '#fabebe', icon: '🐾' }, // Pets
                { color: '#008080', icon: '🎭' }, // Theater
                { color: '#e6beff', icon: '🚴' }  // Cycling
            ];

            // DOM ELEMENTS
            const modal = document.getElementById('friend-modal');
            const modalContent = document.getElementById('modal-content');
            const modalTitle = document.getElementById('modal-title');
            const friendNameInput = document.getElementById('friend-name');
            const friendCityInput = document.getElementById('friend-city');
            const citySuggestions = document.getElementById('city-suggestions');
            const friendFactInput = document.getElementById('friend-fact');
            const cancelButton = document.getElementById('cancel-button');
            const saveButton = document.getElementById('save-button');
            const searchInput = document.getElementById('search-input');
            const searchResults = document.getElementById('search-results');
            const confirmModal = document.getElementById('confirm-modal');
            const confirmModalContent = document.getElementById('confirm-modal-content');
            const confirmFriendName = document.getElementById('confirm-friend-name');
            const confirmCancelButton = document.getElementById('confirm-cancel-button');
            const confirmDeleteButton = document.getElementById('confirm-delete-button');
            const helpButton = document.getElementById('help-button');
            const instructionsModal = document.getElementById('instructions-modal');
            const instructionsContent = document.getElementById('instructions-content');
            const closeInstructions = document.getElementById('close-instructions');
            const themeToggle = document.getElementById('theme-toggle');
            const themeIcon = document.getElementById('theme-icon');
            const iconSelector = document.getElementById('icon-selector');
            const mapStyleSatellite = document.getElementById('map-style-satellite');
            const mapStyleTerrain = document.getElementById('map-style-terrain');
            const mapStyleDefault = document.getElementById('map-style-default');
            const body = document.body;

            // FUNCTIONS
            // Function to create a custom map pin icon with emoji
            const createCustomIcon = (color, emoji) => {
                const iconSvg = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="36" height="36">
                    <path fill="${color}" stroke="#fff" stroke-width="1.5" d="M12 0C7.589 0 4 3.589 4 8c0 4.411 8 16 8 16s8-11.589 8-16c0-4.411-3.589-8-8-8z"/>
                    <text x="12" y="14" font-size="12" text-anchor="middle" fill="white">${emoji}</text>
                </svg>`;
                
                return L.divIcon({
                    html: iconSvg,
                    className: 'custom-marker',
                    iconSize: [36, 36],
                    iconAnchor: [18, 36],
                    popupAnchor: [0, -38]
                });
            };

            // Function to perform reverse geocoding
            const reverseGeocode = async (lat, lng) => {
                try {
                    const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=10&addressdetails=1`);
                    const data = await response.json();
                    
                    if (data && data.address) {
                        const address = data.address;
                        let location = '';
                        
                        if (address.city) location = address.city;
                        else if (address.town) location = address.town;
                        else if (address.village) location = address.village;
                        else if (address.county) location = address.county;
                        
                        if (location && address.country) location += ', ';
                        if (address.country) location += address.country;
                        
                        return location || 'Unknown location';
                    }
                } catch (error) {
                    console.error('Reverse geocoding error:', error);
                }
                
                return 'Unknown location';
            };

            // Function to perform forward geocoding (city name to coordinates)
            const forwardGeocode = async (query) => {
                try {
                    const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=5`);
                    const data = await response.json();
                    
                    return data.map(result => ({
                        name: result.display_name,
                        lat: parseFloat(result.lat),
                        lng: parseFloat(result.lon)
                    }));
                } catch (error) {
                    console.error('Forward geocoding error:', error);
                    return [];
                }
            };

            // Function to open the Add/Edit modal
            const openModal = async (title, buttonText, friendData = null) => {
                modalTitle.textContent = title;
                saveButton.textContent = buttonText;
                
                if (friendData) {
                    friendNameInput.value = friendData.name || '';
                    friendCityInput.value = friendData.city || '';
                    friendFactInput.value = friendData.funFact || '';
                    selectedIcon = iconOptions[friendData.iconIndex || 0].icon;
                    
                    // Set the selected icon
                    document.querySelectorAll('.icon-option').forEach(option => {
                        if (option.dataset.icon === selectedIcon) {
                            option.classList.add('selected');
                        } else {
                            option.classList.remove('selected');
                        }
                    });
                } else {
                    friendNameInput.value = '';
                    friendCityInput.value = '';
                    friendFactInput.value = '';
                    selectedIcon = '🎮';
                    
                    // Reset icon selection
                    document.querySelectorAll('.icon-option').forEach(option => {
                        if (option.dataset.icon === '🎮') {
                            option.classList.add('selected');
                        } else {
                            option.classList.remove('selected');
                        }
                    });
                    
                    // Get location name for new marker
                    if (tempMarkerData) {
                        const locationName = await reverseGeocode(tempMarkerData.lat, tempMarkerData.lng);
                        friendCityInput.value = locationName;
                    }
                }
                
                modal.classList.remove('hidden');
                setTimeout(() => {
                    modal.classList.add('opacity-100');
                    modalContent.classList.remove('scale-95', 'opacity-0');
                    modalContent.classList.add('scale-100', 'opacity-100');
                    friendNameInput.focus();
                }, 10);
            };

            // Function to close the Add/Edit modal
            const closeModal = () => {
                modalContent.classList.remove('scale-100', 'opacity-100');
                modalContent.classList.add('scale-95', 'opacity-0');
                modal.classList.remove('opacity-100');
                setTimeout(() => {
                    modal.classList.add('hidden');
                    tempMarkerData = null;
                    editingFriendId = null;
                    citySuggestions.classList.add('hidden');
                }, 200);
            };

            // Functions to open/close the Confirmation Modal
            const openConfirmModal = () => {
                confirmModal.classList.remove('hidden');
                setTimeout(() => {
                    confirmModal.classList.add('opacity-100');
                    confirmModalContent.classList.remove('scale-95', 'opacity-0');
                    confirmModalContent.classList.add('scale-100', 'opacity-100');
                }, 10);
            };

            const closeConfirmModal = () => {
                confirmModalContent.classList.remove('scale-100', 'opacity-100');
                confirmModalContent.classList.add('scale-95', 'opacity-0');
                confirmModal.classList.remove('opacity-100');
                setTimeout(() => {
                    confirmModal.classList.add('hidden');
                    friendIdToDelete = null;
                }, 200);
            };

            // Show instructions modal
            const showInstructions = () => {
                instructionsModal.classList.remove('hidden');
                setTimeout(() => {
                    instructionsModal.classList.add('opacity-100');
                    instructionsContent.classList.remove('scale-95', 'opacity-0');
                    instructionsContent.classList.add('scale-100', 'opacity-100');
                }, 10);
            };

            // Hide instructions modal
            const hideInstructions = () => {
                instructionsContent.classList.remove('scale-100', 'opacity-100');
                instructionsContent.classList.add('scale-95', 'opacity-0');
                instructionsModal.classList.remove('opacity-100');
                setTimeout(() => {
                    instructionsModal.classList.add('hidden');
                }, 300);
            };

            // Toggle dark/light mode
            const toggleTheme = () => {
                body.classList.toggle('light-mode');
                body.classList.toggle('dark-mode');
                
                if (body.classList.contains('light-mode')) {
                    // Switch to light map tiles
                    map.removeLayer(currentTileLayer);
                    lightTiles.addTo(map);
                    currentTileLayer = lightTiles;
                    themeIcon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />';
                } else {
                    // Switch to dark map tiles
                    map.removeLayer(currentTileLayer);
                    darkTiles.addTo(map);
                    currentTileLayer = darkTiles;
                    themeIcon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />';
                }
            };

            // Change map style
            const changeMapStyle = (style) => {
                map.removeLayer(currentTileLayer);
                
                switch(style) {
                    case 'satellite':
                        satelliteTiles.addTo(map);
                        currentTileLayer = satelliteTiles;
                        break;
                    case 'terrain':
                        terrainTiles.addTo(map);
                        currentTileLayer = terrainTiles;
                        break;
                    case 'default':
                        if (body.classList.contains('light-mode')) {
                            lightTiles.addTo(map);
                            currentTileLayer = lightTiles;
                        } else {
                            darkTiles.addTo(map);
                            currentTileLayer = darkTiles;
                        }
                        break;
                }
            };

            // Save friends to localStorage
            const saveFriends = () => {
                localStorage.setItem('friendsList', JSON.stringify(friends));
            };

            // Load friends from localStorage
            const loadFriends = () => {
                const savedFriends = localStorage.getItem('friendsList');
                if (savedFriends) {
                    friends = JSON.parse(savedFriends);
                    renderMarkers();
                }
            };

            // Render all markers on the map
            const renderMarkers = () => {
                markers.clearLayers();
                markerIdMap = {};
                
                friends.forEach(friend => {
                    addMarkerToMap(friend);
                });
                
                map.addLayer(markers);
            };

            // Add a single marker to the map
            const addMarkerToMap = (friend) => {
                const iconOption = iconOptions[friend.iconIndex || 0];
                const customIcon = createCustomIcon(iconOption.color, iconOption.icon);
                
                const marker = L.marker([friend.lat, friend.lng], { 
                    icon: customIcon,
                    draggable: true
                });
                
                // Create popup content with friend details
                const popupContent = `<div class="custom-popup-content">
                    <div class="name">${friend.name}</div>
                    <div class="location">${friend.city || 'Unknown location'}</div>
                    <div class="coords">Lat: ${friend.lat.toFixed(4)}, Lng: ${friend.lng.toFixed(4)}</div>
                    ${friend.funFact ? `<div class="details">
                        <div>💡 ${friend.funFact}</div>
                    </div>` : ''}
                    <button class="popup-button edit" data-id="${friend.id}">Edit</button>
                    <button class="popup-button delete" data-id="${friend.id}">Delete</button>
                </div>`;
                
                marker.bindPopup(popupContent);
                
                // Add tooltip with friend's name
                marker.bindTooltip(friend.name, {
                    permanent: false,
                    direction: 'top',
                    offset: [0, -10]
                });
                
                // Handle marker dragging
                marker.on('dragend', function(event) {
                    const marker = event.target;
                    const position = marker.getLatLng();
                    
                    // Update friend's position
                    const friendIndex = friends.findIndex(f => f.id === marker.friendId);
                    if (friendIndex !== -1) {
                        friends[friendIndex].lat = position.lat;
                        friends[friendIndex].lng = position.lng;
                        
                        // Update city name
                        reverseGeocode(position.lat, position.lng).then(city => {
                            friends[friendIndex].city = city;
                            saveFriends();
                            renderMarkers();
                        });
                    }
                });
                
                // Store friend ID with the marker object for easy access
                marker.friendId = friend.id;
                
                // Add to our ID map and to the cluster group
                markerIdMap[friend.id] = marker;
                markers.addLayer(marker);
            };

            // Handle adding a new friend
            const handleAddFriend = () => {
                const name = friendNameInput.value.trim();
                if (name && tempMarkerData) {
                    const iconIndex = iconOptions.findIndex(opt => opt.icon === selectedIcon);
                    const newFriend = {
                        id: Date.now(),
                        name: name,
                        lat: tempMarkerData.lat,
                        lng: tempMarkerData.lng,
                        city: friendCityInput.value.trim(),
                        funFact: friendFactInput.value.trim(),
                        iconIndex: iconIndex
                    };
                    
                    friends.push(newFriend);
                    addMarkerToMap(newFriend);
                    saveFriends();
                    closeModal();
                    
                    // Pan to the new marker and open its popup
                    const newMarker = markerIdMap[newFriend.id];
                    map.panTo([newFriend.lat, newFriend.lng]);
                    newMarker.openPopup();
                    
                    // Add pulse animation to the new marker
                    const markerElement = newMarker.getElement();
                    if (markerElement) {
                        markerElement.classList.add('pulse-marker');
                        setTimeout(() => {
                            markerElement.classList.remove('pulse-marker');
                        }, 3000);
                    }
                }
            };

            // Handle editing an existing friend
            const handleEditFriend = () => {
                const newName = friendNameInput.value.trim();
                if (newName && editingFriendId) {
                    const friendIndex = friends.findIndex(f => f.id === editingFriendId);
                    if(friendIndex > -1){
                        const iconIndex = iconOptions.findIndex(opt => opt.icon === selectedIcon);
                        friends[friendIndex].name = newName;
                        friends[friendIndex].city = friendCityInput.value.trim();
                        friends[friendIndex].funFact = friendFactInput.value.trim();
                        friends[friendIndex].iconIndex = iconIndex;
                        saveFriends();
                        renderMarkers();
                    }
                    closeModal();
                }
            };

            // Request deletion and show confirmation modal
            const requestDeleteFriend = (id) => {
                const friend = friends.find(f => f.id === id);
                if (friend) {
                    friendIdToDelete = id;
                    confirmFriendName.textContent = friend.name;
                    openConfirmModal();
                }
            };

            // Actually delete the friend after confirmation
            const handleDeleteFriend = () => {
                if (friendIdToDelete) {
                    friends = friends.filter(friend => friend.id !== friendIdToDelete);
                    saveFriends();
                    renderMarkers();
                    closeConfirmModal();
                }
            };

            // Search/Filter friends
            const handleSearch = (query) => {
                if (!query) {
                    searchResults.innerHTML = '';
                    searchResults.classList.add('hidden');
                    return;
                }
                
                const filteredFriends = friends.filter(friend => 
                    friend.name.toLowerCase().includes(query.toLowerCase()) ||
                    (friend.city && friend.city.toLowerCase().includes(query.toLowerCase())) ||
                    (friend.funFact && friend.funFact.toLowerCase().includes(query.toLowerCase()))
                );
                
                if(filteredFriends.length > 0) {
                    searchResults.classList.remove('hidden');
                    searchResults.innerHTML = filteredFriends.map(friend => {
                        const iconOption = iconOptions[friend.iconIndex || 0];
                        return `<div class="p-3 hover:bg-gray-100 dark:hover:bg-slate-700 cursor-pointer flex items-center" data-id="${friend.id}">
                            <div class="w-8 h-8 rounded-full mr-2 flex items-center justify-center text-white text-sm" style="background-color: ${iconOption.color}">
                                ${iconOption.icon}
                            </div>
                            <div>
                                <div class="font-medium text-gray-800 dark:text-white">${friend.name}</div>
                                <div class="text-xs text-gray-500 dark:text-gray-400">${friend.city || 'Unknown location'}</div>
                            </div>
                        </div>`;
                    }).join('');
                } else {
                    searchResults.classList.add('hidden');
                }
            };

            // Highlight a marker (pulse animation and open popup)
            const highlightMarker = (marker) => {
                // Pan to the marker
                map.panTo(marker.getLatLng());
                
                // Open popup
                marker.openPopup();
                
                // Add pulse animation
                const markerElement = marker.getElement();
                if (markerElement) {
                    markerElement.classList.add('pulse-marker');
                    setTimeout(() => {
                        markerElement.classList.remove('pulse-marker');
                    }, 3000);
                }
            };

            // EVENT LISTENERS

            // Map click event to add a new friend
            map.on('click', (e) => {
                tempMarkerData = e.latlng;
                openModal('Add a Friend', 'Save Friend');
            });

            // Save button in modal
            saveButton.addEventListener('click', () => {
                if(editingFriendId){
                    handleEditFriend();
                } else {
                    handleAddFriend();
                }
            });

            // Friend name input enter key
            friendNameInput.addEventListener('keydown', (e) => {
                if(e.key === 'Enter') {
                    saveButton.click();
                }
            });

            // Cancel button in modal
            cancelButton.addEventListener('click', closeModal);
            
            modal.addEventListener('click', (e) => {
                if (e.target === modal) closeModal();
            });

            // Handle icon selection
            iconSelector.addEventListener('click', (e) => {
                if (e.target.classList.contains('icon-option')) {
                    document.querySelectorAll('.icon-option').forEach(option => {
                        option.classList.remove('selected');
                    });
                    e.target.classList.add('selected');
                    selectedIcon = e.target.dataset.icon;
                }
            });

            // Handle city input with autocomplete
            let citySuggestionsTimeout;
            friendCityInput.addEventListener('input', (e) => {
                const query = e.target.value.trim();
                
                if (query.length < 3) {
                    citySuggestions.classList.add('hidden');
                    return;
                }
                
                clearTimeout(citySuggestionsTimeout);
                citySuggestionsTimeout = setTimeout(async () => {
                    const results = await forwardGeocode(query);
                    
                    if (results.length > 0) {
                        citySuggestions.innerHTML = results.map(result => 
                            `<div class="city-suggestion" data-lat="${result.lat}" data-lng="${result.lng}">${result.name}</div>`
                        ).join('');
                        citySuggestions.classList.remove('hidden');
                    } else {
                        citySuggestions.classList.add('hidden');
                    }
                }, 300);
            });

            // Handle city suggestion selection
            citySuggestions.addEventListener('click', (e) => {
                if (e.target.classList.contains('city-suggestion')) {
                    const lat = parseFloat(e.target.dataset.lat);
                    const lng = parseFloat(e.target.dataset.lng);
                    
                    // Update the temporary marker position
                    tempMarkerData = { lat, lng };
                    
                    // Update the city input
                    friendCityInput.value = e.target.textContent;
                    
                    // Hide suggestions
                    citySuggestions.classList.add('hidden');
                    
                    // Pan the map to the selected location
                    map.panTo([lat, lng]);
                }
            });

            // Handle clicks on edit/delete buttons inside popups
            map.on('popupopen', (e) => {
                const popupNode = e.popup._container;
                if (!popupNode) return;
                
                const editButton = popupNode.querySelector('.edit');
                const deleteButton = popupNode.querySelector('.delete');
                
                if (editButton) {
                    editButton.onclick = () => {
                        const id = parseInt(editButton.dataset.id);
                        const friend = friends.find(f => f.id === id);
                        if(friend) {
                            editingFriendId = id;
                            openModal('Edit Friend', 'Update Friend', friend);
                        }
                    };
                }
                
                if (deleteButton) {
                    deleteButton.onclick = () => {
                        const id = parseInt(deleteButton.dataset.id);
                        requestDeleteFriend(id);
                    };
                }
            });

            // Search input listener
            searchInput.addEventListener('input', (e) => {
                handleSearch(e.target.value);
            });

            // Search result click listener
            searchResults.addEventListener('click', (e) => {
                const target = e.target.closest('div[data-id]');
                if (target) {
                    const id = parseInt(target.dataset.id);
                    const markerToFind = markerIdMap[id];
                    
                    if (markerToFind) {
                        markers.zoomToShowLayer(markerToFind, () => {
                            highlightMarker(markerToFind);
                        });
                    }
                    
                    searchInput.value = '';
                    searchResults.classList.add('hidden');
                }
            });

            // Confirmation modal listeners
            confirmDeleteButton.addEventListener('click', handleDeleteFriend);
            confirmCancelButton.addEventListener('click', closeConfirmModal);
            
            confirmModal.addEventListener('click', (e) => {
                if(e.target === confirmModal) closeConfirmModal();
            });

            // Theme toggle listener
            themeToggle.addEventListener('click', toggleTheme);

            // Map style listeners
            mapStyleSatellite.addEventListener('click', () => changeMapStyle('satellite'));
            mapStyleTerrain.addEventListener('click', () => changeMapStyle('terrain'));
            mapStyleDefault.addEventListener('click', () => changeMapStyle('default'));

            // Instructions modal listeners
            helpButton.addEventListener('click', showInstructions);
            closeInstructions.addEventListener('click', hideInstructions);
            instructionsModal.addEventListener('click', (e) => {
                if(e.target === instructionsModal) hideInstructions();
            });

            // INITIAL LOAD
            loadFriends();
            
            // Show instructions on first visit
            const hasSeenInstructions = localStorage.getItem('hasSeenInstructions');
            if (!hasSeenInstructions) {
                setTimeout(() => {
                    showInstructions();
                    localStorage.setItem('hasSeenInstructions', 'true');
                }, 1000);
            }
            
            // Add sample data if no friends exist
            if (friends.length === 0) {
                // Add sample friend in India
                friends.push({
                    id: Date.now(),
                    name: "David",
                    lat: 22.5,
                    lng: 79,
                    city: "Mumbai, India",
                    funFact: "Loves spicy food!",
                    iconIndex: 4 // Travel icon
                });
                
                // Add a few more sample friends around the world
                friends.push({
                    id: Date.now() + 1,
                    name: "Sarah",
                    lat: 40.7,
                    lng: -74,
                    city: "New York, USA",
                    funFact: "Professional photographer",
                    iconIndex: 6 // Cooking icon
                });
                
                friends.push({
                    id: Date.now() + 2,
                    name: "James",
                    lat: 51.5,
                    lng: -0.1,
                    city: "London, UK",
                    funFact: "Football enthusiast",
                    iconIndex: 2 // Sports icon
                });
                
                friends.push({
                    id: Date.now() + 3,
                    name: "Lisa",
                    lat: -33.9,
                    lng: 151.2,
                    city: "Sydney, Australia",
                    funFact: "Marine biologist",
                    iconIndex: 9 // Outdoors icon
                });
                
                saveFriends();
                renderMarkers();
            }
        });
    </script>
</body>
</html>
